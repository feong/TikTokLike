# TikTokLike

ä»Šå¤©å¼€ä¸€ä¸ªå‘ï¼Œæ¨¡æ‹ŸæŠ–éŸ³å®ç°äº’åŠ¨åŠŸèƒ½ï¼Œè¿™ç¯‡æ–‡ç« ä¼šéšç€é¡¹ç›®çš„è¿›åº¦æ›´æ–°ï¼Œè®°å½•å¼€å‘æµç¨‹ï¼Œé‡åˆ°çš„é—®é¢˜ä¹Ÿé¡ºé“å†™ä¸‹è§£å†³æ–¹æ³•ã€‚

## éœ€æ±‚åˆ†æ

![TikTok](https://i.loli.net/2020/04/24/6hM5wGngf4Lyqzo.jpg)

* ä¸Šä¸‹æ»‘åˆ‡æ¢è§†é¢‘ï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªè§†é¢‘æ­£åœ¨æ’­æ”¾ï¼›
* å¯ä»¥å±•ç¤ºè¯„è®ºåˆ—è¡¨ï¼›
* å¯ä»¥å‘å¸ƒè¯„è®ºã€‚

### æ•°æ®åŠŸèƒ½

ç¬¬äºŒå’Œç¬¬ä¸‰ä¸ªåŠŸèƒ½è¦æ±‚çš„æ•°æ®æš‚ä¸æ¶‰åŠåç«¯æœåŠ¡ï¼Œç›´æ¥mockæ•°æ®ã€‚

è§†é¢‘æ•°æ®æ˜¯ä»é©¬å®¶æŒ–æ¥çš„ï¼Œæœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ ä½¿ç”¨ï¼Œå¦‚æœä¾µæƒè¯·è”ç³»åˆ é™¤ã€‚
è¯„è®ºæ•°æ®æ¥è‡ª[JSONPlaceholder - Fake online REST API for developers](http://jsonplaceholder.typicode.com)ï¼Œè¿™æ¬¡æ²¡æœ‰åšç½‘ç»œè¯·æ±‚ï¼Œç›´æ¥æŠŠæ•°æ®ä»¥jsonæ ¼å¼ä¿å­˜åœ¨é¡¹ç›®ä¸­äº†ã€‚å¦‚æœè¦å®ç°ç½‘ç»œè¯·æ±‚ï¼Œç›´æ¥æ›¿æ¢å¯¹åº”æ–¹æ³•å°±å¥½ã€‚

### UIåŠŸèƒ½

å›åˆ°ç¬¬ä¸€ä¸ªåŠŸèƒ½ï¼Œåˆ†è§£ä¸€ä¸‹éœ€æ±‚ï¼š

1. å¯ä»¥ä¸Šä¸‹åˆ†é¡µçš„æ»šåŠ¨è§†å›¾ï¼›
2. å¯ä»¥æ’­æ”¾è§†é¢‘çš„ç»„ä»¶ï¼›
3. æœ€æ–°æµè¡Œçš„ä»åº•ä¸‹å¼¹å‡ºçš„è§†å›¾ï¼›
4. æ˜¾ç¤ºè¯„è®ºçš„ç»„ä»¶
5. å‘å¸ƒè¯„è®ºçš„ç»„ä»¶
6. åº•æ tab

## å®ç°æ•ˆæœé¢„è§ˆ

![TikTokLike](https://i.loli.net/2020/04/24/TpyK8Cz1SuBIsG3.jpg)

å®Œæˆéœ€æ±‚åˆ—è¡¨ä¸­çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå…¶ä¸­ç¬¬3ç‚¹æ²¡æœ‰åšæˆé‚£ç§å¯ä»¥ä¸‹æ‹‰å…³é—­çš„æ•ˆæœï¼Œæˆ‘ä»¬çš„å®ç°ä¸æ˜¯ç›´æ¥ä½¿ç”¨çš„Modalï¼Œè€Œæ˜¯æ ¹æ®`react-native-navigation`æä¾›çš„æ–¹æ¡ˆï¼ŒæŠŠå®ƒåšæˆäº†ä¸€ä¸ªæ–°çš„é¡µé¢æ ˆï¼Œè¿™æ ·ï¼Œå¼¹å‡ºæ¥çš„é¡µé¢å¯ä»¥å¾ˆç®€å•çš„å®ç°å¼¹å‡ºå†…å®¹çš„é¡µé¢è·³è½¬ã€‚

è¿™æ ·ï¼Œæ•´ä¸ªAppçš„é¡µé¢é€»è¾‘å…³ç³»å¦‚ä¸‹ï¼š
![5ä¸ªtab](https://i.loli.net/2020/04/22/bpF8VXeORvkrIH9.png)

### é¢å¤–åŠŸèƒ½

* åŒå‡»ç‚¹èµï¼Œæ˜¾ç¤ºâ¤ï¸çš„åŠ¨ç”»
  
![â¤ï¸](https://i.loli.net/2020/04/30/PdwNTvUQ9SXkuLn.png)

## é¡¹ç›®æ­å»º

### æ–°å»ºRNé¡¹ç›®

è¿™æ¬¡ç›´æ¥ç”¨typescriptæ¨¡ç‰ˆæ¥æ–°å»ºé¡¹ç›®ï¼Œå‘½ä»¤å¦‚ä¸‹

```shell
npx react-native init TikTokLike --template react-native-template-typescript
```

å¦‚æœåƒæˆ‘ä¸€æ ·å¤±è´¥åœ¨ç¬¬ä¸€æ­¥ï¼ŒğŸ˜„ä¸è¦ç€æ€¥ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯`react-native cli`è¿‡æ—¶äº†ã€‚
react nativeé¡¹ç›®ä¼—æ‰€å‘¨çŸ¥æ›´æ–°ç‰¹åˆ«å¿«ï¼Œç›¸å…³çš„å‘½ä»¤å·¥å…·ï¼Œå’Œè„šæ‰‹æ¶å¦‚æœä¸æ›´æ–°ï¼Œæ‰§è¡Œä¸Šé¢çš„å‘½ä»¤æœ‰å¯èƒ½å¤±è´¥ï¼Œæ¯”å¦‚æˆ‘è¿™è¾¹ä½¿ç”¨çš„æ·˜å®æºï¼Œä¼šæŠ¥æ²¡æœ‰typescript templateçš„é”™è¯¯ã€‚è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå…¨å±€å¸è½½æ‰`react-native cli`å°±è¡Œã€‚

```shell
npm uninstall -g react-native-cli
```

æˆåŠŸåˆå§‹åŒ–é¡¹ç›®ä¹‹åï¼Œåœ¨æ¨¡æ‹Ÿå™¨ä¸­è¿è¡Œï¼Œæ­£å¸¸è·‘é€šğŸ‘Œåå°±å¯ä»¥æ¨é€ä»£ç åˆ°äº†ï¼Œè¯¥é¡¹ç›®å·²ç»åœ¨[github](https://github.com/feong/TikTokLike)å¼€æºã€‚

### ç¬¬ä¸‰æ–¹åº“

react nativeå·²ç»è¯ç”Ÿå¤šå¹´ï¼Œä¸»è¦è§£å†³çš„é—®é¢˜æ˜¯è·¨å¹³å°çš„UIæ„å»ºã€‚å¯¹äºUIæ„å»ºï¼Œæœ‰å¾ˆå¤šä¼˜ç§€çš„ç¬¬ä¸‰æ–¹åº“ï¼Œèƒ½æ»¡è¶³å¤§éƒ¨åˆ†éœ€æ±‚ï¼Œæ¯”å¦‚æœ€å¼€å§‹å°±å¾—åˆ°äº†å®˜æ–¹çš„è®¤å¯çš„`react-navigation`ï¼Œç‚™æ‰‹å¯çƒ­çš„`react-native-paper`ç­‰ç­‰ï¼Œå°±ä¸é‡å¤é€ è½®å­äº†ï¼Œæ‹¿è¿™äº›ä¼˜ç§€çš„åº“æ¥è®¾è®¡è¿™ä¸ªTikTok Likeé¡¹ç›®å§ã€‚

```shell
yarn add @react-navigation/native
yarn add react-native-reanimated react-native-gesture-handler react-native-screens react-native-safe-area-context @react-native-community/masked-view
yarn add @react-navigation/bottom-tabs
yarn add react-native-paper
yarn add react-native-vector-icons
yarn add react-native-video
npx pod-install ios
```

å®‰è£…çš„å‘½ä»¤å¦‚ä¸Šæ‰€è¿°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä½¿ç”¨`react-native-vector-icons`å‡ºç°`Unrecognized font family 'Material Design Icons'`çš„é”™è¯¯ï¼Œé‚£ä¹ˆå°±éœ€è¦linkä¸€ä¸‹è¯¥åº“äº†ï¼Œç„¶åå†æŠŠXCodeé‡Œé¢`Targets > Build Phases > Copy Bundle Resources`é‡Œé¢çš„.ttfæ–‡ä»¶éƒ½åˆ é™¤ï¼Œå¦åˆ™ç¼–è¯‘æ—¶ä¼šå†²çª

```shell
yarn react-native link
```

æ¥ä¸‹æ¥ç®€å•è§£é‡Šå…¶ä¸­å‡ ä¸ªå…³é”®ç»„ä»¶ã€‚

#### React Navigation

```json
"@react-navigation/bottom-tabs": "^5.2.7",
"@react-navigation/native": "^5.1.6",
"@react-navigation/stack": "^5.2.13",
```

`react-navigation`æ˜¯ä¸€ä¸ªè§£å†³appè·¯ç”±æ ˆçš„åº“ï¼Œè®°å¾—åˆšå¼€å§‹ä½¿ç”¨react-navigationçš„æ—¶å€™è¿˜æ˜¯1.Xï¼Œæ˜¯çº¯JSçš„å®ç°ï¼Œå½“å®ƒå‡çº§åˆ°2.Xçš„æ—¶å€™è¿˜å¾ˆé«˜å…´ã€‚åŒæ—¶å®ƒçš„è®¾è®¡æ€è·¯ä¸€ç›´ä¿æŒä¸æ—¶ä¿±è¿›ï¼Œè‡ªä»`react hooks`å‡ºæ¥ä¹‹åï¼Œ`react-navigation`å¾ˆå¿«ä¹Ÿè½¬å‘hooksçš„å®ç°ï¼Œç»„ä»¶ä¹Ÿéƒ½å˜æˆäº†å‡½æ•°çš„å†™æ³•ï¼Œæ›´æ–°åˆ°5.Xç‰ˆæœ¬ã€‚å¦å¤–æœ€è¿‘æµè¡Œçš„ä»é¡µé¢åº•ä¸‹å¼¹å‡ºæ–°çš„è·¯ç”±æ ˆçš„åŠŸèƒ½ä¹Ÿç»™å¼€å‘è€…æä¾›å®ç°æ–¹æ³•ï¼Œä¸å¾—ä¸è¯´ï¼Œè¿™ä¸ªåº“éå¸¸å¥½ç”¨ğŸ‘ã€‚

#### React Native Paper

```json
"react-native-paper": "^3.8.0",
```

`react-native-paper`æä¾›äº†è¯¸å¦‚æŒ‰é’®ï¼Œæ–‡å­—ï¼Œè¾“å…¥ï¼Œè¡¨å•ç­‰å¸¸ç”¨çš„ç»„ä»¶ä»¥åŠä¸»é¢˜çš„å®šåˆ¶ï¼Œéµå¾ªMaterial Designçš„è®¾è®¡æ€è·¯ï¼Œå†™çš„éå¸¸è§„èŒƒï¼Œæ•ˆæœä¹Ÿå¾ˆå¥½ï¼Œå¦‚æœè¦å®ç°æ·±è‰²ä¸»é¢˜ï¼Œä¼šéå¸¸çœå¿ƒï¼Œæ‰€ä»¥è¿™æ¬¡çš„åŸºç¡€ç»„ä»¶éƒ½æ¥è‡ªäºå®ƒã€‚
å¦å¤–å†æ’ä¸€å¥ï¼Œ`react-navigation`çš„BottomTabNavigatorå°±æ˜¯åŸºäº`react-native-paper`æä¾›çš„BottomNavigationå®ç°ï¼Œæ‰€ä»¥å¼ºå¼ºè”æ‰‹ï¼Œæ€èƒ½ä¸å¥½ç”¨å‘¢ã€‚

#### React Native Vector Icons

```json
"react-native-vector-icons": "^6.6.0",
```

Appå®ç°é€šè¿‡å­—ç¬¦æ–‡ä»¶å®ç°çŸ¢é‡å›¾æ ‡çš„ç»„ä»¶ã€‚

#### React Native Video

```json
"react-native-video": "^4.4.5"
```

æ’­æ”¾è§†é¢‘çš„ç»„ä»¶ï¼Œä½¿ç”¨éå¸¸ç®€å•ã€‚

## é¡¹ç›®å®ç°

å•°å—¦äº†è¿™ä¹ˆå¤šï¼Œå¯ä»¥å¼€å§‹å†™ä»£ç äº†

### å¯ä»¥ä¸Šä¸‹åˆ†é¡µçš„æ»šåŠ¨è§†å›¾

è¿™ä¸ªç»„ä»¶æ˜¯æ‰©å±•äº†`react-native`çš„FlatListç»„ä»¶ï¼Œå¯ç”¨`pagingEnabled`å±æ€§ï¼ŒåŒæ—¶æŠŠå®ƒçš„å­ç»„ä»¶ï¼Œæ”¾åœ¨ä¸€ä¸ªé«˜åº¦ä¸ºåˆ—è¡¨é«˜åº¦çš„Viewä¸­ï¼Œè¿™æ ·å°±èƒ½å®ç°è¿™ä¸ªéœ€æ±‚ï¼›å¦å¤–å¯ä»¥å†å¢å¼ºä¸€ä¸‹ï¼Œä¼ å…¥åˆ†é¡µè¯·æ±‚çš„`query`ï¼Œè¿™æ ·ä¸éœ€è¦ä¼ å…¥`data`ï¼Œèƒ½å¤Ÿç¿»åˆ°åˆ¶å®šçš„é¡µé¢è‡ªåŠ¨è·å–æ–°æ•°æ®ã€‚

| æ‰©å±•å‚æ•°           | åŠŸèƒ½                                       | å¿…å¡« |
| ------------------ | ------------------------------------------ | ---- |
| query              | ä¼ ä¸€ä¸ªåˆ¶å®šæ ¼å¼çš„åˆ†é¡µè¯·æ±‚ï¼Œå®ç°è‡ªåŠ¨æ‹‰å–æ•°æ® |      |
| onPageIndexChanged | ç¿»é¡µäº‹ä»¶                                   | å¯é€‰ |

| ç§»é™¤çš„å‚æ•°                   | è§£é‡Š                            |
| ---------------------------- | ------------------------------- |
| data                         | é€šè¿‡queryè‡ªåŠ¨è·å–               |
| pagingEnabled                | åˆ†é¡µæ»šåŠ¨æ•ˆæœ                    |
| bounces                      | iOSçš„å¼¹ç°§æ•ˆæœç§»é™¤               |
| showsVerticalScrollIndicator | æ‹‰æ†ç§»é™¤                        |
| scrollsToTop                 | iOSç‚¹å‡»é¡¶éƒ¨è‡ªåŠ¨å›åˆ°é¡¶éƒ¨åŠŸèƒ½ç§»é™¤ |
| onLayout                     | ç”¨äºè·å–åˆ—è¡¨é«˜åº¦                |
| onScroll                     | ç”¨äºè®¡ç®—å½“å‰é¡µé¢                |

1. typeå£°æ˜

```typescript
interface Props<ItemT, Variables>
  extends Omit<
    FlatListProps<ItemT>,
    | 'data'
    | 'pagingEnabled'
    | 'bounces'
    | 'showsVerticalScrollIndicator'
    | 'scrollsToTop'
    | 'onLayout'
    | 'onScroll'
  > {
  query: (
    variables: {
      afterIndex?: number;
      length?: number;
    } & Variables,
  ) => Promise<{data: Array<ItemT>; remain: number}>;
  variables?: Variables;
  onPageIndexChanged?: (index: number) => void;
}
```

2. åˆ†é¡µå®ç°å’Œå†…å­˜ä¼˜åŒ–

```typescript
const DEFAULT_UNMOUNT_LENGTH_AWAY = 5;
export function PagingList<T extends {id: number}>(
  props: Props<T, {length?: number}>,
) {
  const [viewHeight, setViewHeight] = React.useState(0);
  const [currentPageIndex, setCurrentPageIndex] = React.useState(0);

  return (
    <FlatList
      {...props} // props should not be customized should be put under this line.
      pagingEnabled // å®ç°åˆ†é¡µæ»šåŠ¨
      bounces={false}
      showsVerticalScrollIndicator={false}
      scrollsToTop={false}
      renderItem={(item) => {
        const shouldMount =
          Math.abs(item.index - currentPageIndex) < DEFAULT_UNMOUNT_LENGTH_AWAY;
        // æ¯ä¸ªå­é¡¹åŒ…å«åœ¨ä¸€ä¸ªé«˜åº¦ä¸ºåˆ—è¡¨é«˜åº¦çš„Viewä¸­
        // å¦‚æœå½“å‰é¡µé¢æ˜¯20ï¼Œé‚£ä¹ˆ16é¡µä¹‹å‰çš„é¡µé¢ä¸å†æ¸²æŸ“ï¼Œ24é¡µä¹‹åçš„é¡µé¢ä¸å†æ¸²æŸ“
        // ä¸å†æ¸²æŸ“çš„ç»„ä»¶æ›¿æ¢æˆnull
        return (
          <View style={{height: viewHeight}}>
            {shouldMount && renderItem ? renderItem(item) : null}
          </View>
        );
      }}
      onLayout={(e) => {
        const {height} = e.nativeEvent.layout;
        setViewHeight(height);
      }}
      onScroll={(event) => {
        const offsetY = event.nativeEvent.contentOffset.y;
        if (viewHeight > 0) {
          const pageIndex = Math.ceil(offsetY / viewHeight);
          if (pageIndex !== currentPageIndex) {
            setCurrentPageIndex(pageIndex);
          }
        }
      }}
    />
  );
}
```

3. è‡ªåŠ¨åˆ†é¡µæ‹‰å–æ•°æ®

```typescript
const DEFAULT_PRE_FETCH_INDEX = 3; // if there is only 3 item left, then fetch more data
export function PagingList<T extends {id: number}>(
  props: Props<T, {length?: number}>,
) {
  const [data, setData] = React.useState<T[]>([]);
  const [remain, setRemain] = React.useState(0);
  const [loading, setLoading] = React.useState(false);

  const fetchData = async () => {
    try {
      if (loading) {
        return;
      }
      setLoading(true);
      const ret = await query({
        afterIndex: data.length > 0 ? data[0].id : -1,
        length,
      });
      setData(data.concat(ret.data));
      setRemain(ret.remain);
    } catch (error) {
    } finally {
      setLoading(false);
    }
  };

  React.useEffect(() => {
    // ç¬¬ä¸€æ¬¡åŠ è½½ç»„ä»¶è·å–æ•°æ®
    fetchData();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [query, variables]);

  const onPageChanged = (index: number) => {
    setCurrentPageIndex(index);
    if (
      remain > 0 &&
      data.length - currentPageIndex - 1 < DEFAULT_PRE_FETCH_INDEX
    ) {
      // ç¿»åˆ°å€’æ•°ç¬¬3é¡µï¼Œè·å–æ›´å¤šæ•°æ®
      fetchData();
    }
    // å¯¹å¤–æŠ›å‡ºç¿»é¡µäº‹ä»¶
    onPageIndexChanged && onPageIndexChanged(index);
  };

  return (
    <FlatList
      keyExtractor={(item) => `${item.id}`}
      initialNumToRender={20}
      {...props} // props should not be customized should be put under this line.
      onScroll={(event) => {
        const offsetY = event.nativeEvent.contentOffset.y;
        if (viewHeight > 0) {
          const pageIndex = Math.ceil(offsetY / viewHeight);
          if (pageIndex !== currentPageIndex) {
            onPageChanged(pageIndex);
          }
        }
      }}
    />
  );
}
```

### å¯ä»¥æ’­æ”¾è§†é¢‘çš„ç»„ä»¶

ç›´æ¥ä½¿ç”¨`react-native-video`ï¼Œå¤–é¢å¥—ä¸€ä¸ªTouchableWithoutFeedbackå®ç°ç‚¹å‡»`æ’­æ”¾`å’Œ`æš‚åœ`ä¹‹å‰çš„åˆ‡æ¢ã€‚

| å‚æ•°            | åŠŸèƒ½             | å¿…å¡« |
| --------------- | ---------------- | ---- |
| uri             | è§†é¢‘åœ°å€         |      |
| paused          | è®¾å®šæš‚åœçŠ¶æ€     | å¯é€‰ |
| onPausedChanged | æš‚åœçŠ¶æ€æ›´æ–°äº‹ä»¶ | å¯é€‰ |

### æœ€æ–°æµè¡Œçš„ä»åº•ä¸‹å¼¹å‡ºçš„è§†å›¾

ä½¿ç”¨`react-navigation`ï¼Œç‹¬ç«‹å‡ºä¸€ç»„Modalè·¯ç”±æ ˆï¼Œå…·ä½“çš„å¯ä»¥æŸ¥é˜…[å®˜æ–¹æ–‡æ¡£](https://reactnavigation.org/docs/modal)

```typescript
const AppStack = createStackNavigator();

const App = () => {
  return (
    <NavigationContainer>
      <PaperProvider>
        <AppStack.Navigator mode="modal">
          <AppStack.Screen
            name="Main"
            component={RootViews} // RootViewsæ˜¯ä¸€ä¸ªBottom Tabs
            options={{headerShown: false}}
          />
          <AppStack.Screen
            name="Comment"
            component={CommentStream} // CommentStreamå•ç‹¬çš„ä¸€ä¸ªè¯„è®ºè·¯ç”±æ ˆ
            options={{
              headerShown: false,
              cardStyle: {backgroundColor: 'transparent'},
            }}
          />
        </AppStack.Navigator>
      </PaperProvider>
    </NavigationContainer>
  );
};
```

### æ˜¾ç¤ºè¯„è®ºçš„ç»„ä»¶

```typescript
export const CommentStream: React.FC<CommentStreamProps> = (props) => {
  const navigation = useNavigation();
  const {videoId} = props.route.params;
  // ç”±äºæ²¡æœ‰ä½¿ç”¨Redux/MobXçŠ¶æ€ç®¡ç†æœºåˆ¶ï¼Œæ‰€ä»¥ä½¿ç”¨fetchTimeå¤„ç†å…„å¼Ÿç»„ä»¶é—´çš„çŠ¶æ€ä¼ é€’ã€‚è¿™é‡Œå‘å¸ƒè¯„è®ºéœ€è¦å¼ºåˆ¶æ›´æ–°è¯„è®ºåˆ—è¡¨
  const [fetchTime, setFetchTime] = React.useState(Date.now());
  const [commentCount, setCommentCount] = React.useState<number>();
  const onPosted = React.useCallback(() => {
    setFetchTime(Date.now());
  }, []);

  return (
    // è¿™é‡ŒKeyboardAvoidingViewæ˜¯è§£å†³é”®ç›˜é®æŒ¡çš„é—®é¢˜ï¼Œä¸€å®šè¦æ”¾åœ¨æ•´ä¸ªå±å¹•è§†å›¾æœ€å¤–å±‚æ‰èƒ½æ­£ç¡®padding
    <KeyboardAvoidingView style={styles.container} behavior="padding">
      <TouchableWithoutFeedback onPress={navigation.goBack}>
        <View style={styles.shadowPanel} />
      </TouchableWithoutFeedback>
      <View style={styles.commentPanel}>
        <CommentHeader
          title={
            commentCount === undefined ? 'comments' : `${commentCount} comments`
          }
        />
        <CommentList
          videoId={videoId}
          fetchTime={fetchTime}
          onFetched={setCommentCount}
        />
        <CommentPost videoId={videoId} onPosted={onPosted} />
      </View>
    </KeyboardAvoidingView>
  );
};
```

### å‘å¸ƒè¯„è®ºçš„ç»„ä»¶

```typescript
export const CommentPost: React.FC<CommentPostProps> = (props) => {
  const {videoId, onPosted} = props;
  const [text, setText] = React.useState('');

  return (
    // è¿™ä¸ªç»„ä»¶å·²ç»æ˜¯å±å¹•æœ€åº•ä¸‹çš„è§†å›¾äº†ï¼Œä½¿ç”¨SafeAreaViewæ¥ç¡®ä¿å…¨é¢å±æ‰‹æœºèƒ½æ­£å¸¸ä½¿ç”¨
    <TouchableWithoutFeedback>
      <SafeAreaView style={styles.container}>
        <TextInput
          value={text}
          onChangeText={setText}
          style={styles.text}
          placeholder={INITIAL_TEXT}
          placeholderTextColor={Colors.grey100}
          onFocus={() => setText('')}
          onBlur={() => setText(INITIAL_TEXT)}
        />
        <IconButton
          icon="arrow-left-bold-circle"
          size={32}
          color={Colors.blue500}
          onPress={async () => {
            if (text) {
              await postComment(videoId, text);
              Keyboard.dismiss();
              onPosted();
            }
          }}
        />
      </SafeAreaView>
    </TouchableWithoutFeedback>
  );
};
```

### åº•æ Tab Navigation

ç›´æ¥å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://reactnavigation.org/docs/bottom-tab-navigator)ï¼Œå¾ˆå®¹æ˜“å°±æŠŠæ ·å¼å†™å®Œã€‚

### è§†é¢‘Tab

```typescript
export const VideoTab: React.FC<VideoTabProps> = () => {
  const navigation = useNavigation();

  const [paused, setPaused] = React.useState(false); // pausedå’Œå½“å‰æ’­æ”¾çš„Videoç»„ä»¶åŒæ­¥
  const [pageIndex, setPageIndex] = React.useState(0); // pageIndexå½“å‰é¡µ

  React.useEffect(() => {
    const unsubscribeForBlur = navigation.addListener('blur', () => {
      setPaused(true); // åº•æ tabåˆ‡æ¢ä¹‹åï¼Œéœ€è¦æš‚åœè§†é¢‘
    });
    return unsubscribeForBlur;
  }, [navigation]);

  return (
    <PagingList
      query={fetchVideoStream}
      renderItem={({item, index}) => {
        return (
          <VideoSocials
            data={item}
            paused={paused || pageIndex !== index} // éå½“å‰é¡µçš„è§†é¢‘æš‚åœ
            onPausedChanged={setPaused}
          />
        );
      }}
      onPageIndexChanged={(index) => {
        setPageIndex(index);
        setPaused(false);
      }}
    />
  );
};
```

## é¢å¤–çš„å®ç°

### åŒå‡»ç‚¹èµâ¤ï¸

åœ¨è¿™é‡Œæˆ‘ä»¬å®šä¹‰ï¼šä¸€å®šæ—¶é—´å†…ï¼Œè§†å›¾è¿›è¡Œä½ç§»ã€å˜å½¢å°±æ˜¯ç®€å•çš„åŠ¨ç”»ã€‚å®è´¨å°±æ˜¯æœ‰ä¸€ä¸ªå€¼èƒ½éšç€æ—¶é—´æŒ‰é¢„å®šçš„æ–¹å¼æ›´æ–°ï¼Œå½“è¿™ä¸ªå€¼ç”¨åœ¨ä¸€ä¸ªè§†å›¾çš„æ ·å¼ä¸­ï¼Œå°±èƒ½å®ç°åŠ¨ç”»ã€‚
æˆ‘ä»¬å°†ç”¨`react-native-reanimated`æ¥å®ç°è¿™ä¸ªå€¼ï¼Œç¨åä¼šè¯´ã€‚

å…ˆæ¢³ç†åŠ¨ç”»äº¤äº’é€»è¾‘ï¼š

1. è§†é¢‘å¢åŠ å•å‡»å’ŒåŒå‡»äº‹ä»¶ï¼ˆè¿™ä¸ªäº‹ä»¶æ”¾åœ¨è§†é¢‘æ‰€åœ¨çš„å®¹å™¨ä¸­ä¼šæ›´åŠ åˆç†ï¼ŒçŠ¶æ€åœ¨å®¹å™¨ä¸­ç®¡ç†ï¼‰
2. å•å‡»è§†é¢‘æš‚åœ/ç»§ç»­æ’­æ”¾
3. åŒå‡»åœ¨äº‹ä»¶æ‰€åœ¨ä½ç½®ç”Ÿæˆä¸€ä¸ªçˆ±å¿ƒåŠ¨ç”»ï¼šå¤§å°0åˆ°2å€æ‹‰ä¼¸ï¼›é€æ˜åº¦ä»1åˆ°0

åœ¨ä¹‹å‰çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬ç”¨çš„æ˜¯å®˜æ–¹åº“ä¸­çš„`TouchableWithoutFeedback`ï¼Œä»–èƒ½å¾ˆç®€å•çš„å®ç°å•å‡»çš„å“åº”ï¼Œè¦å®ç°åŒå‡»å°±éœ€è¦è‡ªå·±è®°å½•ä¸¤æ¬¡ç‚¹å‡»çš„æ—¶é—´å·®äº†ï¼Œç¹çã€‚æœ‰æ²¡æœ‰æ›´ç®€å•çš„å®ç°å‘¢ï¼Ÿè¿˜è®°å¾—æˆ‘ä»¬è£…`react-navigation`è¿™ä¸ªåº“çš„æ—¶å€™æ˜¯ä¸æ˜¯é¢å¤–å®‰è£…äº†`react-native-gesture-handler`è¿™ä¸ªåº“å—ï¼Ÿåœ¨å®˜ç½‘å¯ä»¥äº†è§£ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸ºäº¤äº’æä¾›ç®€å•æ§åˆ¶çš„æ–¹æ¡ˆï¼Œå®ç°åŒå‡»ä¸åœ¨è¯ä¸‹ï¼Œç›´æ¥ä¸Šå®˜ç½‘å®ç°[Cross handler interactions Â· React Native Gesture Handler](https://software-mansion.github.io/react-native-gesture-handler/docs/interactions.html)

```typescript
const onSingleTapped = (event: TapGestureHandlerStateChangeEvent) => {
  if (event.nativeEvent.state === State.ACTIVE) {
    const nextState = !paused;
    setPaused(nextState);
    onPausedChanged && onPausedChanged(nextState);
  }
};

const onDoubleTapped = (event: TapGestureHandlerStateChangeEvent) => {
  if (event.nativeEvent.state === State.ACTIVE) {
    onDoubleTap &&
      onDoubleTap({x: event.nativeEvent.x, y: event.nativeEvent.y});
  }
};

<TapGestureHandler
  waitFor={doubleTap}
  onHandlerStateChange={onSingleTapped}>
  <TapGestureHandler
    ref={doubleTap}
    onHandlerStateChange={onDoubleTapped}
    numberOfTaps={2}>
    <View style={styles.backgroundVideo}>
      <RNVideo repeat paused={paused} source={{uri}} style={styles.video} />
    </View>
  </TapGestureHandler>
</TapGestureHandler>
```

ç»§ç»­è¯´åŠ¨ç”»å€¼ç”¨`react-native-reanimated`çš„åŸå› ï¼š

1. æµè¡Œï¼Œå¾ˆå¤šç¬¬ä¸‰æ–¹åº“éƒ½åœ¨ç”¨ï¼›
2. å¼ºå¤§ï¼ŒåŠ¨ç”»æŒ‰æ¡ä»¶åˆ¤æ–­æ¸²æŸ“ä¸åŒæ•ˆæœä¸éœ€è¦é€šè¿‡JSï¼Œç›´æ¥åœ¨åŸç”Ÿå®Œæˆã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦çš„å°±æ˜¯ä¸€ä¸ªèƒ½å˜åŒ–çš„`scale`å€¼ï¼Œå’Œä¸€ä¸ª`opacity`å€¼ï¼š

```typescript
/**
 * @param params.init åˆå€¼
 * @param params.dest ç›®æ ‡å€¼
 * @param params.duration åŠ¨ç”»æ—¶é—´
 * @param params.clock æ§åˆ¶å™¨
 * @param params.onFinished åŠ¨ç”»ç»“æŸçš„å›è°ƒ
 */
export const runNumberTiming = (params: {
  init: number;
  dest: number;
  duration?: number;
  clock?: Animated.Clock;
  onFinished?: () => void;
}) => {
  const {
    init,
    dest,
    duration = 2000,
    clock = new Clock(),
    onFinished = () => {},
  } = params;
  const state = {
    finished: new Value(0),
    position: new Value(init),
    time: new Value(0),
    frameTime: new Value(0),
  };

  const config = {
    duration,
    toValue: new Value(dest),
    easing: Easing.inOut(Easing.ease),
  };

  // ä¸‹é¢è¿™äº›æ–¹æ³•åœ¨åŠ¨ç”»çš„æ¯ä¸€å¸§éƒ½å°†é‡æ–°è®¡ç®—
  return block([
    cond(
      clockRunning(clock),
      [
        // å¦‚æœåŠ¨ç”»æ­£åœ¨è¿›è¡Œï¼Œä¸”æœ‰æ–°çš„ç›®æ ‡å€¼ï¼Œåˆ™æ›´æ–°ç›®æ ‡å€¼
        set(config.toValue, dest),
      ],
      [
        // å¯åŠ¨æ§åˆ¶å™¨
        startClock(clock),
      ],
    ),
    // åŠ¨ç”»å€¼çš„æ›´æ–°æ–¹å¼
    timing(clock, state, config),
    // åŠ¨ç”»ç»“æŸï¼Œå…³é—­æ§åˆ¶å™¨ï¼Œè°ƒç”¨callback
    cond(state.finished, [stopClock(clock), call([], onFinished)]),
    // è¿”å›åŠ¨ç”»å€¼
    state.position,
  ]);
};
```

è§†å›¾éƒ¨åˆ†ï¼š

```typescript
export const HeartAnimation = React.memo((props: HeartAnimationProps) => {
  const {offsetX, offsetY} = props;
  const [finished, setFinished] = React.useState(false);

  // ä¸ºäº†èŠ‚çœç©ºé—´ï¼ŒåŠ¨ç”»ç»“æŸåï¼Œç§»é™¤è§†å›¾
  if (finished) {
    return null;
  }

  // ä½¿ç”¨åŒä¸€ä¸ªåŠ¨ç”»æ§åˆ¶å™¨ï¼ŒåŠ¨ç”»opacityå’Œscaleå±æ€§
  const clock = new Clock();
  const opacity = runNumberTiming({
    clock,
    init: 1,
    dest: 0,
    onFinished: () => {
      setFinished(true);
    },
  });
  const scale = runNumberTiming({clock, init: 0, dest: 2});
  return (
    <Animated.View
      style={{
        position: 'absolute',
        top: offsetY - HEART_ICON_SIZE / 2,
        left: offsetX - HEART_ICON_SIZE / 2,
        opacity,
        transform: [{scale}],
      }}>
      <Heart />
    </Animated.View>
  );
});
```

å½“ç”¨æˆ·åŒå‡»è§†é¢‘ä¹‹åï¼Œæˆ‘ä»¬æ‹¿åˆ°ä¸€ä¸ªåæ ‡ï¼ŒæŠŠè¿™ä¸ªåæ ‡ä¸€ä¸€è®°å½•åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œç„¶åå°†æ•°ç»„ä¼ é€’ç»™çˆ±å¿ƒæœ¦æ¿ï¼Œè¿™ä¸ªæœ¦æ¿éœ€è¦å æ»¡è§†é¢‘ï¼Œä¸”ä¸å“åº”äº¤äº’äº‹ä»¶ï¼Œç„¶ååœ¨æœ¦æ¿ä¸­åœ¨å¯¹åº”çš„åæ ‡ç»˜åˆ¶â¤ï¸åŠ¨ç”»

```typescript
export const VideoSocials: React.FC<VideoSocialsProps> = (props) => {
  const [points, setPoints] = React.useState<iPointStamp[]>([]);
  const {data, paused, onPausedChanged} = props;

  const onVideoDoubleTap = React.useCallback((point: iPoint) => {
    setPoints((pre) =>
      pre.concat(Object.assign({timestamp: Date.now()}, point)),
    ); // å°†åæ ‡å­˜å…¥æ•°ç»„
  }, []);

  return (
    <View style={styles.container}>
      <Video
        uri={data.uri}
        paused={paused}
        onPausedChanged={onPausedChanged}
        onDoubleTap={onVideoDoubleTap}
      />
      <Comment videoId={data.id} comment={data.comment} style={styles.social} />
      {/* åæ ‡æ•°ç»„ä¼ åˆ°æœ¦æ¿ä¸­ */}
      <HeartAnimationFullView style={styles.heart} points={points} />
    </View>
  );
};
```

```typescript
export const HeartAnimationFullView = React.memo(
  (props: HeartAnimationFullViewProps) => {
    const {points, style} = props;

    // æœ¦æ¿çš„pointerEventsåˆ«å¿˜è®°è®¾ç½®
    return (
      <View style={style} pointerEvents="none">
        {points.map((item) => (
          <HeartAnimation
            key={item.timestamp}
            offsetX={item.x}
            offsetY={item.y}
          />
        ))}
      </View>
    );
  },
);
```

å®Œå·¥

## TODO

ä»¥ä¸Šå°±æ˜¯è¿™æ¬¡çš„éœ€æ±‚å†…å®¹ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ä¼šæ·»åŠ ä¸€äº›åŠ¨ç”»æ•ˆæœæ¥æå‡ç”¨æˆ·ä½“éªŒã€‚

* ~~â¤ï¸LikeåŠ¨ç”»~~ï¼ˆå·²å®Œæˆï¼‰
* mockè¯·æ±‚apiçš„æ›´æ–°

tips

* babel plugin éœ€è¦`yarn start --reset-cache`

refs

* *[Using TypeScript with React Native Â· React Native](https://reactnative.dev/docs/typescript)*
* *[Getting Started Â· React Native Paper](https://reactnative.dev/docs/typescript)*
* *[Opening a full-screen modal | React Navigation](https://reactnavigation.org/docs/modal)*
* *[createBottomTabNavigator | React Navigation](https://reactnavigation.org/docs/bottom-tab-navigator)*
* *[React Native Gesture Handler Â· Declarative API exposing platform native touch and gesture system to React Native.](https://software-mansion.github.io/react-native-gesture-handler/)*
* *[React Native Reanimated](https://software-mansion.github.io/react-native-reanimated/index.html)*
